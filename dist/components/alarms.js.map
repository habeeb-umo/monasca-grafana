{"version":3,"sources":["../../src/components/alarms.js"],"names":["config","appEvents","MonascaClient","AlarmsPageCtrl","$scope","$injector","$location","backendSrv","datasourceSrv","alertSrv","monasca","metricFilters","stateFilters","severityFilters","defIdFilters","totalFilters","editFilterIndex","search","dimensions","split","map","kv","k","v","metric_dimensions","id","pageLoaded","loadFailed","alarms","loadAlarms","suggestDimensionNames","_suggestDimensionNames","bind","suggestDimensionValues","_suggestDimensionValues","query","callback","listDimensionNames","then","filter","key","listDimensionValues","index","push","splice","every","f","value","refreshAlarms","i","length","temp","alarm_definition_id","listAlarms","catch","set","err","message","deleting","findIndex","n","find","setAlarmDeleting","deleteAlarm","alarmDeleted","alarm","emit","title","text","text2","name","yesText","icon","onConfirm","confirmDeleteAlarm","templateUrl"],"mappings":"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","file":"alarms.js","sourcesContent":["/*\n *   Copyright 2017 StackHPC\n *   (C) Copyright 2017 Hewlett Packard Enterprise Development LP\n *\n *   Licensed under the Apache License, Version 2.0 (the \"License\");\n *   you may not use this file except in compliance with the License.\n *   You may obtain a copy of the License at\n *\n *       http://www.apache.org/licenses/LICENSE-2.0\n *\n *   Unless required by applicable law or agreed to in writing, software\n *   distributed under the License is distributed on an \"AS IS\" BASIS,\n *   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *   See the License for the specific language governing permissions and\n *   limitations under the License.\n */\n\nimport config from 'app/core/config';\nimport appEvents from 'app/core/app_events';\nimport MonascaClient from './monasca_client';\n\nexport class AlarmsPageCtrl {\n\n  /** @ngInject */\n  constructor($scope, $injector, $location, backendSrv, datasourceSrv, alertSrv) {\n    this.alertSrv = alertSrv\n    this.monasca = new MonascaClient(backendSrv, datasourceSrv);\n\n    this.metricFilters = [];\n    this.stateFilters = [];\n    this.severityFilters = [];\n    this.defIdFilters = [];\n    this.totalFilters = [];\n\n    this.editFilterIndex = -1;\n\n    if ('dimensions' in $location.search()) {\n      this.metricFilters = $location.search().dimensions\n\t.split(',')\n\t.map(kv => kv.split(':'))\n\t.map(([k, v]) => ({ metric_dimensions: k + \":\" + v }));\n    }\n\n    if ('id' in $location.search()){\n      this.defIdFilters[0] = $location.search().id;\n    }\n\n    this.pageLoaded = false;\n    this.loadFailed = false;\n    this.alarms = [];\n    this.loadAlarms();\n\n    this.suggestDimensionNames = this._suggestDimensionNames.bind(this);\n    this.suggestDimensionValues = this._suggestDimensionValues.bind(this);\n  }\n\n  _suggestDimensionNames(query, callback) {\n    this.monasca.listDimensionNames().then(callback);\n  }\n\n  _suggestDimensionValues(query, callback) {\n    var filter = this.metricFilters[this.editFilterIndex];\n    if (filter && filter.key) {\n      this.monasca.listDimensionValues(filter.key).then(callback);\n    }\n  }\n\n  editFilter(index) {\n    this.editFilterIndex = index;\n  }\n\n  //Metric Dimension Filter add/remove\n\n  addMetricFilter() {\n    this.metricFilters.push({});\n  }\n\n  removeMetricFilter(index) {\n    var filter = this.metricFilters[index];\n    this.metricFilters.splice(index, 1);\n  }\n\n  //State Filter add/remove\n\n  addStateFilter() {\n    this.stateFilters.push({});\n  }\n\n  removeStateFilter(index) {\n    var filter = this.stateFilters[index];\n    this.stateFilters.splice(index, 1);\n  }\n\n  //Severity Filter add/remove\n\n  addSeverityFilter() {\n    this.severityFilters.push({});\n  }\n\n  removeSeverityFilter(index) {\n    var filter = this.severityFilters[index];\n    this.severityFilters.splice(index, 1);\n  }\n\n  applyFilter() {\n    // Check filter is complete before applying.\n    if (this.metricFilters.every(function (f){\n        f.metric_dimensions = f.key + \":\" + f.value;\n        return f.metric_dimensions;\n    })){\n      this.refreshAlarms();\n      this.refreshAlarms();\n    }\n  }\n\n  refreshAlarms() {\n    if (this.pageLoaded) {\n      this.pageLoaded = false;\n      this.loadAlarms();\n      this.pageLoaded = true;\n    }\n  }\n\n  loadAlarms() {\n    this.totalFilters = [];\n    if (this.metricFilters){\n      for (var i = 0; i < this.metricFilters.length; i++){\n        this.totalFilters.push(this.metricFilters[i]);\n      }\n    }\n    if (this.stateFilters){\n      for (var i = 0; i < this.stateFilters.length; i++){\n        this.totalFilters.push(this.stateFilters[i]);\n      }\n    }\n    if (this.severityFilters){\n      for (var i = 0; i < this.severityFilters.length; i++){\n        this.totalFilters.push(this.severityFilters[i]);\n      }\n    }\n    if (this.defIdFilters){\n      var temp = {};\n      temp.alarm_definition_id = this.defIdFilters[0];\n      this.totalFilters.push(temp);\n      }\n\n    this.monasca.listAlarms(this.totalFilters).then(alarms => {\n      this.alarms = alarms;\n    }).catch(err => {\n      this.alertSrv.set(\"Failed to get alarms.\", err.message, 'error', 10000);\n      this.loadFailed = true;\n    }).then(() => {\n      this.pageLoaded = true;\n    });\n  }\n\n  setAlarmDeleting(id, deleting) {\n    var index = this.alarms.findIndex(n => n.id === id);\n    if (index !== -1) {\n      this.alarms[index].deleting = true;\n    }\n  }\n\n  alarmDeleted(id) {\n    var index = this.alarms.find(n => n.id === id);\n    if (index !== -1) {\n      this.alarms.splice(index, 1);\n    }\n  }\n\n  confirmDeleteAlarm(id) {\n    this.setAlarmDeleting(id, true);\n\n    this.monasca.deleteAlarm(id).then(() => {\n      this.alarmDeleted(id);\n    }).catch(err => {\n      this.setAlarmDeleting(id, false);\n      this.alertSrv.set(\"Failed to delete alarm.\", err.message, 'error', 10000);\n    });\n  }\n\n  deleteAlarm(alarm) {\n    appEvents.emit('confirm-modal', {\n      title: 'Delete',\n      text: 'Are you sure you want to delete this alarm?',\n      text2: alarm.name,\n      yesText: \"Delete\",\n      icon: \"fa-trash\",\n      onConfirm: () => {\n        this.confirmDeleteAlarm(alarm.id);\n      }\n    });\n  }\n}\n\nAlarmsPageCtrl.templateUrl = 'components/alarms.html';\n"]}